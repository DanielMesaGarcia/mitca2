{"type":"operationStart","subtype":"profile","data":{"_id":"6PzAcdc9mJpHXsde","timestamp":"2024-01-17T17:43:23.550Z","state":"queued","mode":"full","creationDate":"2024-01-17T17:43:23.553Z","modificationDate":"2024-01-17T17:43:23.553Z","shortid":"4RMmOrn","$entitySet":"profiles"},"doDiffs":false,"timestamp":1705513403551,"id":"h4p6789w7avd3kh","previousOperationId":null,"operationId":"qxrzvdy08zpjyuq"}
{"type":"log","level":"info","message":"Render request 1 queued for execution and waiting for available worker","previousOperationId":"qxrzvdy08zpjyuq","timestamp":1705513403552,"id":"p6hqb7lmirmjrtq"}
{"type":"operationStart","subtype":"render","name":"orders-main","previousOperationId":"qxrzvdy08zpjyuq","timestamp":1705513403570,"id":"ltr4kw8qkyzqc4q","previousEventId":"h4p6789w7avd3kh","operationId":"zlf15m53lbzfsiq","res":{"content":null,"meta":{"diff":"Index: resMeta\n===================================================================\n--- resMeta\n+++ resMeta\n@@ -1,0 +1,1 @@\n\\ No newline at end of file\n+{}\n\\ No newline at end of file\n"}},"req":{"diff":"Index: req\n===================================================================\n--- req\n+++ req\n@@ -1,0 +1,58 @@\n\\ No newline at end of file\n+{\n+  \"template\": {\n+    \"name\": \"orders-main\",\n+    \"recipe\": \"chrome-pdf\",\n+    \"shortid\": \"HJH11D83ce\",\n+    \"folder\": {\n+      \"shortid\": \"erkLzi\"\n+    },\n+    \"engine\": \"handlebars\",\n+    \"scripts\": [\n+      {\n+        \"isGlobal\": false,\n+        \"scope\": \"template\",\n+        \"name\": \"orders-script\",\n+        \"shortid\": \"BJX1Jw82ce\",\n+        \"folder\": {\n+          \"shortid\": \"erkLzi\"\n+        },\n+        \"_id\": \"CF6y3hSFBuDHiw4G\",\n+        \"__entitySet\": \"scripts\",\n+        \"__name\": \"orders-script\",\n+        \"creationDate\": \"2024-01-09T20:01:17.677Z\",\n+        \"modificationDate\": \"2024-01-17T17:43:16.468Z\",\n+        \"content\": \"const axios = require('axios');\\nconst nodemailer = require('nodemailer');\\n\\n// Configuración del transporte de correo\\nconst transporter = nodemailer.createTransport({\\n  service: 'gmail',\\n  auth: {\\n    user: 'daniwlmesa12@gmail.com', // Reemplaza con tu dirección de correo electrónico\\n    pass: 'Danielkrtk12' // Reemplaza con tu contraseña\\n  }\\n});\\n\\nfunction sendEmail(to, subject, html) {\\n  const mailOptions = {\\n    from: 'tu_correo@gmail.com', // Reemplaza con tu dirección de correo electrónico\\n    to,\\n    subject,\\n    html\\n  };\\n\\n  return transporter.sendMail(mailOptions);\\n}\\n\\nfunction fetchData() {\\n  const apiUrl = 'http://localhost:3001/races';\\n\\n  return axios.get(apiUrl)\\n    .then(response => response.data)\\n    .catch(error => {\\n      console.error('Error fetching data:', error);\\n      throw error;\\n    });\\n}\\n\\nfunction transformData(data) {\\n  return data.data.map(race => {\\n    const raceRunners = race.runners.map(runner => ({\\n      id: runner._id,\\n      name: runner.name,\\n      phone: runner.phone,\\n    }));\\n\\n    return {\\n      country: race._id,\\n      city: race.city,\\n      eventDate: race.eventDate,\\n      length: race.length,\\n      runners: raceRunners,\\n      runnerCount: race.runners.length,\\n    };\\n  });\\n}\\n\\nfunction beforeRender(req, res, done) {\\n  fetchData()\\n    .then(data => {\\n      const transformedData = transformData(data);\\n\\n      // Assign the transformed data to the 'orders' variable in the template\\n      req.data = {\\n        orders: transformedData\\n      };\\n\\n      // Render the HTML template\\n      const html = renderYourHtmlTemplate(req.data); // Debes implementar esta función según tu entorno\\n\\n      // Enviar el informe por correo electrónico\\n      const toEmail = req.body.email; // Suponiendo que el correo electrónico se proporciona en el cuerpo de la solicitud\\n      const emailSubject = 'Informe de carreras';\\n      \\n      sendEmail(toEmail, emailSubject, html)\\n        .then(() => {\\n          console.log('Informe enviado por correo electrónico');\\n          done();\\n        })\\n        .catch(error => {\\n          console.error('Error al enviar el informe por correo electrónico:', error);\\n          res.statusCode = 500;\\n          res.end(`Error: ${error.message}`);\\n        });\\n    })\\n    .catch(error => {\\n      res.statusCode = 500;\\n      res.end(`Error: ${error.message}`);\\n    });\\n}\\n\",\n+        \"__isLoaded\": true,\n+        \"__isGlobal\": false,\n+        \"__scope\": \"template\",\n+        \"__shortid\": \"BJX1Jw82ce\",\n+        \"__folder\": {\n+          \"shortid\": \"erkLzi\"\n+        }\n+      }\n+    ],\n+    \"chrome\": {\n+      \"printBackground\": true,\n+      \"marginTop\": \"4cm\",\n+      \"marginRight\": \"1.5cm\",\n+      \"marginBottom\": \"1.5cm\",\n+      \"marginLeft\": \"1.5cm\",\n+      \"waitForJS\": false,\n+      \"headerTemplate\": \"\",\n+      \"footerTemplate\": \"\"\n+    },\n+    \"pdfOperations\": [\n+      {\n+        \"type\": \"merge\",\n+        \"templateShortid\": \"SJVbqZr9f\",\n+        \"renderForEveryPage\": false,\n+        \"mergeWholeDocument\": true\n+      }\n+    ],\n+    \"creationDate\": \"2024-01-09T20:01:17.644Z\",\n+    \"modificationDate\": \"2024-01-17T17:38:43.666Z\",\n+    \"content\": \"<html>\\n\\n<head>\\n    <meta content=\\\"text/html; charset=utf-8\\\" http-equiv=\\\"Content-Type\\\">\\n    <link rel=\\\"stylesheet\\\" href=\\\"https://cdnjs.cloudflare.com/ajax/libs/metro/4.1.5/css/metro.min.css\\\">\\n    <script src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js'></script>\\n</head>\\n\\n<body>\\n    <div>\\n        <canvas id='runnersChart'></canvas>\\n    </div>\\n   \\n\\n\\n    {{#each orders}}\\n        <div>\\n            <p>Total Runners: {{this.runnerCount}}</p>\\n        </div>\\n        {{{pdfCreatePagesGroup this.country}}}\\n        <canvas id='orders{{this.country}}' style=\\\"margin-bottom:30px\\\"></canvas>\\n        <table class='table striped'>\\n            <thead>\\n                <tr>\\n                    <th>City</th>\\n                    <th>Event date</th>\\n                    <th>Length (km)</th>\\n                </tr>\\n            </thead>\\n            <tbody>\\n                <tr>\\n                    <td>{{this.city}}</td>\\n                    <td>{{this.eventDate}}</td>\\n                    <td>{{this.length}}</td>\\n                </tr>\\n            </tbody>\\n        </table>\\n        <table class='table striped'>\\n            <thead>\\n                <tr>\\n                    <th>DNI</th>\\n                    <th>Name</th>\\n                    <th>Phone number</th>\\n                </tr>\\n            </thead>\\n            <tbody>\\n                {{#each this.runners}}\\n                    <tr>\\n                        <td>{{id}}</td>\\n                        <td>{{name}}</td>\\n                        <td>{{phone}}</td>\\n                    </tr>\\n                {{/each}}\\n            </tbody>\\n        </table>\\n\\n        <div style='page-break-after: always;'></div>\\n    {{/each}}\\n</body>\\n\\n\\n\\n</html>\",\n+    \"helpers\": \"\"\n+  },\n+  \"data\": {}\n+}\n\\ No newline at end of file\n"}}
{"type":"log","timestamp":1705513403572,"level":"info","message":"Starting rendering request 1","meta":{"rootId":"zojprhhfluqhaql","id":"zojprhhfluqhaql"},"id":"sl6ick0qoznjkw9","previousOperationId":"zlf15m53lbzfsiq"}
{"type":"log","timestamp":1705513403573,"level":"info","message":"Rendering template { name: orders-main, recipe: chrome-pdf, engine: handlebars, preview: true }","meta":{"rootId":"zojprhhfluqhaql","id":"zojprhhfluqhaql"},"id":"x3afrsulieqnlf3","previousOperationId":"zlf15m53lbzfsiq"}
{"type":"log","timestamp":1705513403575,"level":"debug","message":"Data item not defined for this template.","meta":{"rootId":"zojprhhfluqhaql","id":"zojprhhfluqhaql"},"id":"wictz303xhwc7at","previousOperationId":"zlf15m53lbzfsiq"}
{"type":"log","timestamp":1705513403578,"level":"debug","message":"Executing script orders-script (beforeRender)","meta":{"rootId":"zojprhhfluqhaql","id":"zojprhhfluqhaql"},"id":"cfl6v2vmcxvisvc","previousOperationId":"zlf15m53lbzfsiq"}
{"type":"operationStart","subtype":"scriptsBeforeRender","name":"scripts beforeRender","timestamp":1705513403818,"id":"xmikg3ytbf2hwbw","previousEventId":"ltr4kw8qkyzqc4q","operationId":"zmc0zshkk9046dg","previousOperationId":"zlf15m53lbzfsiq","res":{"content":null,"meta":{"diff":"Index: resMeta\n===================================================================\n--- resMeta\n+++ resMeta\n@@ -1,1 +1,1 @@\n-{}\n\\ No newline at end of file\n+{\"reportName\":\"orders-main\",\"headers\":{}}\n\\ No newline at end of file\n"}},"req":{"diff":"Index: req\n===================================================================\n--- req\n+++ req\n@@ -3,5 +3,2 @@\n-    \"name\": \"orders-main\",\n-    \"recipe\": \"chrome-pdf\",\n-    \"shortid\": \"HJH11D83ce\",\n-    \"folder\": {\n-      \"shortid\": \"erkLzi\"\n+    \"phantom\": {\n+      \"waitForJS\": true\n@@ -9,0 +6,1 @@\n+    \"recipe\": \"chrome-pdf\",\n@@ -34,0 +32,2 @@\n+    \"shortid\": \"HJH11D83ce\",\n+    \"name\": \"orders-main\",\n@@ -52,0 +52,2 @@\n+    \"inheritedReadPermissions\": [],\n+    \"inheritedEditPermissions\": [],\n@@ -54,0 +56,1 @@\n+    \"_id\": \"T5fNpAsEOKUaD6Dw\",\n@@ -55,1 +58,4 @@\n-    \"helpers\": \"\"\n+    \"helpers\": \"\",\n+    \"folder\": {\n+      \"shortid\": \"erkLzi\"\n+    }\n"}}
{"type":"operationStart","subtype":"script","name":"scripts orders-script","previousOperationId":"zmc0zshkk9046dg","timestamp":1705513403820,"id":"wl8vap7ffza70jw","previousEventId":"xmikg3ytbf2hwbw","operationId":"s5psq4k1ir5keyt","res":{"content":null,"meta":{"diff":"Index: resMeta\n===================================================================\n--- resMeta\n+++ resMeta\n"}},"req":{"diff":"Index: req\n===================================================================\n--- req\n+++ req\n"}}
{"type":"log","level":"error","message":"Report render failed\n(because) res.end is not a function\nTypeError: res.end is not a function\n    at sandbox.js:84:11\n    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)","previousOperationId":"qxrzvdy08zpjyuq","timestamp":1705513403845,"id":"ng48brxx4ccr2p1"}
{"type":"error","timestamp":1705513403845,"code":"WORKER_CRASHED","id":"1phrkc0q8pw7xlm","stack":"TypeError: res.end is not a function\n    at sandbox.js:84:11\n    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)","message":"res.end is not a function"}
